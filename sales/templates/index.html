{% extends 'app.html' %}
{% load static %}
{% block title %} Cadastro Vendas {% endblock %}
{% block content %}


<div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center py-2 mb-2">
    <ol class="breadcrumb breadcrumb-alt">
        <li class="breadcrumb-item fw-bold" aria-current="page">
            Cadastro Vendas
        </li>
    </ol>
</div>

<div class="row items-push">
    <div class="col-sm-4 col-xxl-4 mb-3">
        <form method="GET" id="search-form">
            <div class="input-group">
                <input type="text" class="form-control form-control-alt" name="search" value="{{ request.GET.search }}"
                    placeholder="Nome do Cliente ou Fornecedor...">
                <span class="input-group-text border-0">
                    <i class="fa fa-search" id="search-btn"></i>
                </span>
            </div>
        </form>
    </div>
    
    <div class="col-sm-5 col-xxl-5 mb-3 form-group">
        {% if perms.sales.add_venda %}
            <a href="{% url 'vendas.new' %}"><button type="button" class="btn btn-alt-success shadow-none fw-semibold">Nova Venda</button></a>
        {% endif %}
    </div>
    
    <div class="col-sm-3 col-xxl-3 mb-3">
        <div class="text-end mt-2 fs-xs fw-semibold">
            <span>{{ str_registros }}</span>
        </div>
    </div>
</div>

<div class="tabela">
    <table>
        <thead>
            <th style="width: 35%;">Fornecedor</th>
            <th style="width: 35%;">Cliente</th>
            <th style="width: 15%;">Valor (R$)</th>
            <th style="width: 15%;">Ações</th>
        </thead>

        <tbody>
            {% for venda in vendas %}
            <tr>
                <td>{{ venda.fornecedor }}</td>
                <td>{{ venda.cliente }}</td>
                <td>{{ venda.valor }}</td>
      
                <td class="text-center">
                    <div>
                        {% if perms.sales.change_venda %}
                        <a href="{% url 'vendas.edit' venda.uuid %}"><button data-bs-toggle="tooltip"
                            data-bs-placement="top" title="Editar"
                                class="btn btn-sm py-0 fs-xs btn-alt-secondary shadow-none">
                                <i class="fa-regular fa-pen-to-square p-0 text-primary"></i></button></a>
                        {% endif %}

                        {% if perms.sales.delete_venda %}
                        <a class="delete-button btn btn-sm py-0 fs-xs btn-alt-secondary shadow-none" data-bs-toggle="tooltip"
                        data-bs-placement="top" title="Excluir"
                            data-url="{% url 'vendas.delete' venda.id %}"
                            data-info="{{ cadastro.cliente }}"><i class="fa-regular fa-trash-can p-0 text-danger"></i></a>
                        {% endif %}
                    </div>
                </td>

            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if messages %}
{% for message in messages %}
{% if 'app_messages' in message.tags %}
<div id="django-{{ message.level_tag }}-message" style="display: none;">{{ message }}</div>
{% endif %}
{% endfor %}
{% endif %}

<script>
    var searchBtn = $('#search-btn');
    var searchForm = $('#search-form');
    $(searchBtn).on('click', function () {
        searchForm.submit();
    })

    $(document).ready(function () {
    
        $('.delete-button').click(function () {
            const deleteUrl = this.getAttribute('data-url');
            var csrfToken = $("input[name='csrfmiddlewaretoken']").val();
            var info = this.getAttribute('data-info')

            Swal.fire({
                title: 'Você tem certeza?',
                html: `<div style="font-size: 13px;">A venda ao cliente "<strong>${info}</strong>" será excluída!</div>`,
                icon: 'warning',
                showCancelButton: true,
                allowOutsideClick: false,
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, Excluir!'
            }).then((result) => {
                if (result.isConfirmed) {

                    location.href = deleteUrl

                }
            })

        });

        var successMessageElement = document.getElementById('django-success-message')
        var errorMessageElement = document.getElementById('django-error-message')

        if (successMessageElement) {
            var msg = successMessageElement.innerText;
            One.helpers('jq-notify', {
                type: 'success',
                icon: 'fa fa-check me-1',
                message: msg
            })
        }

        if (errorMessageElement) {
            var msg = errorMessageElement.innerText;
            One.helpers('jq-notify', {
                type: 'danger',
                icon: 'fa fa-times me-1',
                message: msg
            })
        }
    })

</script>

{% endblock %}